#+TITLE: AWS Snapshot Profiler
#+AUTHOR: AWS Snapshot Benchmarking Tool
#+DATE: 2025-11-10

* Purpose

This tool benchmarks AWS EBS snapshot creation performance by:
- Creating random files of configurable size to simulate disk activity
- Measuring snapshot creation time for multiple snapshots
- Recording results to CSV
- Copying snapshots across regions and creating AMIs

* Prerequisites

- EC2 instance running Amazon Linux 2 or Ubuntu
- Python 3.6+
- AWS CLI configured
- ~boto3~ Python library

* Installation

** 1. Clone Repository
#+BEGIN_SRC bash
git clone <repository-url>
cd aws-snapshot-profiler
#+END_SRC

** 2. Install Dependencies
#+BEGIN_SRC bash
  dnf -y install pip git
  pip3 install boto3
#+END_SRC

** 3. Setup IAM Permissions
#+BEGIN_SRC bash
cd src
chmod +x setup_iam.sh
./setup_iam.sh
#+END_SRC

** 4. Attach Instance Profile
Attach the ~EC2SnapshotProfile~ to your EC2 instance via AWS Console:
- EC2 → Instances → Select Instance → Actions → Security → Modify IAM Role
- Select ~EC2SnapshotProfile~

* Usage

** Run Benchmark
#+BEGIN_SRC bash
cd src
# Basic usage (1 snapshot, 10GB file, default CSV name)
python3 snapshot_benchmark.py

# Create multiple snapshots
python3 snapshot_benchmark.py -n 5

# Custom file size (20GB)
python3 snapshot_benchmark.py -s 20

# Multiple snapshots with custom size and filename
python3 snapshot_benchmark.py -n 3 -s 5 -o benchmark_data.csv

# Show help
python3 snapshot_benchmark.py -h
#+END_SRC

** Command Line Options
- ~-n, --num-snapshots~: Number of snapshots to create (default: 1)
- ~-s, --size~: File size in GB (default: 10)
- ~-o, --output~: Output CSV filename (default: snapshot_results.csv)

** Output
- Console progress updates
- CSV file with timing data
- Snapshot ID and AMI ID upon completion

** CSV Format
#+BEGIN_EXAMPLE
snapshot_number,elapsed_time
1,245.67
#+END_EXAMPLE

* Process Flow

1. For each snapshot iteration:
   - Creates ~/tmp/aws-snapshot-profiler-{random}.dat~ with specified size
   - Detects current instance and root volume
   - Creates EBS snapshot and measures time
   - Records timing to CSV
2. After all snapshots, copies final snapshot to different region
3. Creates AMI from copied snapshot

* Required Permissions

The IAM policy grants:
- ~ec2:CreateSnapshot~
- ~ec2:DescribeSnapshots~
- ~ec2:DescribeInstances~
- ~ec2:DescribeVolumes~
- ~ec2:CopySnapshot~
- ~ec2:RegisterImage~
- ~ec2:DescribeRegions~

* Troubleshooting

** Permission Errors
Ensure IAM role is attached and has required permissions.

** Metadata Access Issues
Verify script runs on EC2 instance, not locally.

** Region Availability
Script automatically selects target region. Ensure account has access to multiple regions.
