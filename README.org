#+TITLE: AWS Snapshot Profiler
#+AUTHOR: AWS Snapshot Benchmarking Tool
#+DATE: 2025-11-10

* Purpose

This tool benchmarks AWS EBS snapshot creation performance by:
- Creating random files of configurable size to simulate disk activity
- Measuring snapshot creation time for multiple snapshots
- Recording results to CSV
- Creating AMI from the last snapshot in the same region with timing measurements

* Prerequisites

- EC2 instance running Amazon Linux 2 or Ubuntu
- Python 3.6+
- AWS CLI configured
- ~boto3~ Python library

* Installation

** 1. Clone Repository
#+BEGIN_SRC bash
git clone <repository-url>
cd aws-snapshot-profiler
#+END_SRC

** 2. Install Dependencies
#+BEGIN_SRC bash
  dnf -y install pip git
  pip3 install boto3
#+END_SRC

** 3. Setup IAM Permissions
#+BEGIN_SRC bash
cd src
chmod +x setup_iam.sh
./setup_iam.sh
#+END_SRC

*Warning:* The included IAM policy (~iam_policy.json~) grants broad EC2 permissions (~ec2:*~) and is intended for testing purposes only. For production use, create a more restrictive policy with only the minimum required permissions.

** 4. Attach Instance Profile
Attach the ~EC2SnapshotProfile~ to your EC2 instance via AWS Console:
- EC2 → Instances → Select Instance → Actions → Security → Modify IAM Role
- Select ~EC2SnapshotProfile~

* Usage

** Run Benchmark
#+BEGIN_SRC bash
  export AWS_DEFAULT_REGION=us-east-1

  cd src
  # Basic usage (1 snapshot, 10GB file, default CSV name)
  python3 snapshot_benchmark.py

  # Create multiple snapshots
  python3 snapshot_benchmark.py -n 5

  # Custom file size (20GB)
  python3 snapshot_benchmark.py -s 20

  # Multiple snapshots with custom size and filename
  python3 snapshot_benchmark.py -n 3 -s 5 -o benchmark_data.csv

  # Custom AMI timing CSV filename
  python3 snapshot_benchmark.py -a ami_timing.csv

  # Show help
  python3 snapshot_benchmark.py -h
#+END_SRC

** Command Line Options
- ~-n, --num-snapshots~: Number of snapshots to create (default: 1)
- ~-s, --size~: File size in GB (default: 10)
- ~-o, --output~: Output CSV filename (default: snapshot_results.csv)
- ~-a, --ami-csv~: AMI creation CSV filename (default: ami_results.csv)

** Output
- Console progress updates
- CSV file with snapshot timing data
- Separate CSV file with AMI creation timing data
- Snapshot ID and AMI ID upon completion

** CSV Format

*** Snapshot Results CSV
#+BEGIN_EXAMPLE
snapshot_number,elapsed_time
1,245.67
#+END_EXAMPLE

*** AMI Results CSV
#+BEGIN_EXAMPLE
ami_id,elapsed_time
ami-0123456789abcdef0,180.45
#+END_EXAMPLE

* Process Flow

1. For each snapshot iteration:
   - Creates ~/tmp/aws-snapshot-profiler-{random}.dat~ with specified size
   - Detects current instance and root volume
   - Creates EBS snapshot and measures time
   - Records timing to CSV
2. After all snapshots, creates AMI from the last snapshot in the same region
3. Measures AMI creation time and records to separate CSV file

* Required Permissions

The IAM policy grants:
- ~ec2:CreateSnapshot~
- ~ec2:CreateTags~
- ~ec2:DescribeSnapshots~
- ~ec2:DescribeInstances~
- ~ec2:DescribeVolumes~
- ~ec2:RegisterImage~
- ~ec2:DescribeImages~

* Troubleshooting

** Permission Errors
Ensure IAM role is attached and has required permissions.

** Metadata Access Issues
Verify script runs on EC2 instance, not locally.
